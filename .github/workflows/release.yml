name: Release on plugin.json version bump

on:
  push:
    branches: [ "main" ]
    paths:
      - "src/plugin.json"
      - "src/**"
      - ".github/workflows/release.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Read version from src/plugin.json
        id: ver
        shell: pwsh
        run: |
          $p = "src/plugin.json"
          if (!(Test-Path $p)) { throw "Missing $p" }
          $json = Get-Content $p -Raw | ConvertFrom-Json
          $version = $json.Version
          if ([string]::IsNullOrWhiteSpace($version)) { throw "plugin.json Version is empty" }
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "tag=v$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Check if tag already exists
        id: tagcheck
        shell: pwsh
        run: |
          $tag = "${{ steps.ver.outputs.tag }}"
          $exists = $false
          git fetch --tags | Out-Null
          $tags = git tag
          if ($tags -contains $tag) { $exists = $true }
          "exists=$exists" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Stop (tag already exists)
        if: steps.tagcheck.outputs.exists == 'true'
        shell: pwsh
        run: |
          Write-Host "Tag already exists. Skip release."

      - name: Restore
        if: steps.tagcheck.outputs.exists != 'true'
        working-directory: src
        run: dotnet restore

      - name: Publish
        if: steps.tagcheck.outputs.exists != 'true'
        working-directory: src
        run: dotnet publish -c Release -o ..\dist\tmp

            - name: Assemble package (copy required files, remove pdb, zip)
        if: steps.tagcheck.outputs.exists != 'true'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $tmp = "dist\tmp"
          if (!(Test-Path $tmp)) { throw "Missing $tmp" }

          Copy-Item "src\plugin.json"  "$tmp\plugin.json"  -Force

          if (Test-Path "src\icon.png") {
            Copy-Item "src\icon.png" "$tmp\icon.png" -Force
          }

          if (Test-Path "src\keywords.json") {
            Copy-Item "src\keywords.json" "$tmp\keywords.json" -Force
          }

          Remove-Item "$tmp\*.pdb" -ErrorAction SilentlyContinue

          $zip = "dist\Flow.Launcher.Plugin.AliasFlow.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }

          Compress-Archive "$tmp\*" $zip -Force


      - name: Create Git tag
        if: steps.tagcheck.outputs.exists != 'true'
        shell: pwsh
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          $tag = "${{ steps.ver.outputs.tag }}"
          git tag $tag
          git push origin $tag

      - name: Create GitHub Release and upload asset
        if: steps.tagcheck.outputs.exists != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: Alias Flow ${{ steps.ver.outputs.version }}
          generate_release_notes: true
          files: |
            dist/Flow.Launcher.Plugin.AliasFlow.zip